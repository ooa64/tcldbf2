package require tcltest
namespace import ::tcltest::*

testConstraint noSingleProc [expr {![configure -singleproc]}]
testConstraint utf8 [expr {[encoding system] eq "utf-8"}]
testConstraint !utf8 [expr {[encoding system] ne "utf-8"}]

# dbf syntax

test compat-1.0 "package version" -constraints noSingleProc -body {
   package require dbf
} -result {1.3*} -match glob

test compat-1.1 "create invalid name" -constraints noSingleProc -body {
   dbf d -create __notexistent__/foo
} -result {0} -returnCodes 0 

test compat-1.2 "open invalid name" -constraints noSingleProc -body {
   dbf d -open __notexistent__/foo
} -result {Error: could not open input file __notexistent__?foo} -returnCodes 1 -match glob 

test compat-1.3 "open invalid file" -constraints noSingleProc -setup {
   set f [tcltest::makeFile "bar" foo]
} -cleanup {
   tcltest::removeFile foo; unset f
} -body {
   dbf d -open $f
} -result {Error: could not open input file *\foo} -match glob -returnCodes 1

test compat-1.4 {create success} -constraints noSingleProc -cleanup {
   catch {$d forget; unset d}
   catch {file delete [file join [temporaryDirectory] test.dbf]}
} -body {
   dbf d -create [file join [temporaryDirectory] test.dbf]
} -result {1}

test compat-1.5 {open success} -constraints noSingleProc -setup {
   dbf d -create [file join [temporaryDirectory] test.dbf]
   $d forget; unset d
} -cleanup {
   catch {$d forget; unset d}
   catch {file delete [file join [temporaryDirectory] test.dbf]}
} -body {
   dbf d -open [file join [temporaryDirectory] test.dbf]
} -result {1}

test compat-2.0 {insert too many values} -constraints noSingleProc -setup {
   dbf d -create [file join [temporaryDirectory] test.dbf] 
   $d add C String 10 0
} -cleanup {
   catch {$d forget; unset d}
   catch {file delete [file join [temporaryDirectory] test.dbf]}
} -body {
   $d insert end {foo} {bar}
} -result {0}

test compat-2.1 {insert invalid logical} -constraints noSingleProc -setup {
   dbf d -create [file join [temporaryDirectory] test.dbf]
   $d add L Logical 1 0
} -cleanup {
   catch {$d forget; unset d}
   catch {file delete [file join [temporaryDirectory] test.dbf]}
} -body {
   $d insert end X
} -result {0}

test compat-2.2 {float format} -constraints noSingleProc -setup {
   dbf d -create [file join [temporaryDirectory] test.dbf]
   $d add N Double 10 2
} -cleanup {
   catch {$d forget; unset d}
   catch {file delete [file join [temporaryDirectory] test.dbf]}
} -body {
   $d insert 0 1.2
   $d record 0
} -result {1.20}

test compat-3.1 {nonascii data} -constraints {noSingleProc !utf} -setup {
   dbf d -create [file join [temporaryDirectory] test.dbf]
   $d add S String 10
   $d insert 0 {Йцукенгшщз}
} -cleanup {
   catch {$d forget; unset d}
   catch {file delete [file join [temporaryDirectory] test.dbf]}
} -body {
   $d record 0
} -result {Йцукенгшщз}

test compat-3.1 {nonascii data} -constraints {noSingleProc utf} -setup {
   dbf d -create [file join [temporaryDirectory] test.dbf]
   $d add S String 10
   $d insert 0 {Йцукенгшщз}
} -cleanup {
   catch {$d forget; unset d}
   catch {file delete [file join [temporaryDirectory] test.dbf]}
} -body {
   $d record 0
} -result {Йцуке}

cleanupTests
